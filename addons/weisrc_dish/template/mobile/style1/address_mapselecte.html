<!DOCTYPE html>
<html>
{template 'common/header'}
<head lang="en">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
        <title>高德地图测试</title>
            <script src="http://webapi.amap.com/maps?v=1.3&key=c93e1e293e5b1c3dc581f3ff633144d3&plugin=AMap.Autocomplete,AMap.PlaceSearch,AMap.Walking,AMap.Riding,AMap.Geolocation"></script>
        <script src="http://webapi.amap.com/ui/1.0/main.js"></script>
        <script type="text/javascript" src="http://webapi.amap.com/demos/js/liteToolbar.js"></script>
        <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
        <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
        <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
        <style>
            html,body,#container{ height:100%; }
                #addressmap{
                    background-color: #ccc;
                }
        </style>
</head>
<body>
   <div id="container" ></div>
   <div   class="form-group" style="position:absolute;top:0px;">
        <div class="mui-input-row mui-search">
            <input   name="resourceAddress" id="addressmap"  type="search"  style="width:70%;" class="mui-input-clear" placeholder="地址搜索">
            <input type="button" onclick="markLocation()" style="padding: 6px 7px;" value="搜索">
            <input type="button"  id="suremap"  class="btn mui-btn-primary"  style="padding: 6px 6px;" value="确定">
            <input type="hidden" id="lon" name="lon" value="">
            <input type="hidden" id="lat" name="lat" value="">
        </div>
    </div>
<script>
    $('#suremap').click(function () {
        var lat=$('#lat').val()
        var lon=$('#lon').val()
           if(!lon || !lat){
               alert('定位失败请重新定位')
           }
        var myValue = $('#addressmap').val()
        var url = "{$addurl}&myValue="+myValue+"&lat="+lat+"&lng="+lon
        console.log(url)
        // document.location.href=url
    })
    var map,addMarker,auto;
    var geocoder;
    var placeSearch;
    var lnglatXY;
    $(function(){
        // 加入高的地图
        map = new AMap.Map('container', {
            resizeEnable: true,
            zoom:15,
            center: [106.724426, 26.604594]
        });
        AMap.plugin('AMap.Geolocation', function() {
            var geolocation = new AMap.Geolocation({
                enableHighAccuracy: false,//是否使用高精度定位，默认:true
                timeout: 10000,          //超过10秒后停止定位，默认：5s
                buttonPosition:'RB',    //定位按钮的停靠位置
                buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                zoomToAccuracy: true,   //定位成功后是否自动调整地图视野到定位点

            });
            map.addControl(geolocation);
            geolocation.getCurrentPosition(function(status,result){
                if(status == 'complete'){
                    onComplete(result)
                }else{
                    onError(result)
                }
            });
        });
        //解析定位结果
        function onComplete(data) {
          console.log('定位成功')
            var str = [];
            str.push('定位结果：' + data.position);
            str.push('定位类别：' + data.location_type);
            if(data.accuracy){
                str.push('精度：' + data.accuracy + ' 米');
            }//如为IP精确定位结果则没有精度信息
            str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
            document.getElementById('result').innerHTML = str.join('<br>');
        }
        //解析定位错误信息
        function onError(data) {
            alert('定位失败')
            console.log(data)
        }
        addMarker([106.724426,26.604594])
        //输入提示
        var auto = new AMap.Autocomplete({
            input: "addressmap"
        });
        AMap.plugin(['AMap.ToolBar','AMap.Scale'],
            function(){
                map.addControl(new AMap.ToolBar());

                map.addControl(new AMap.Scale());
            });
        AMap.service('AMap.Geocoder',function(){//回调函数
            //实例化Geocoder
            geocoder = new AMap.Geocoder({
                city: "贵阳",//城市，默认：“全国”
                adius : 1000
            });
            //TODO: 使用geocoder 对象完成相关功能
        });
        // 加载搜索列表
        myMapViewLocation();
        AMap.service(["AMap.PlaceSearch"], function() {
            placeSearch = new AMap.PlaceSearch({ //构造地点查询类
                pageSize: 5,
                pageIndex: 1,
                city: "贵阳", //城市
                map: map,
                panel: "panel"
            });
        });
        //为地图注册click事件获取鼠标点击出的经纬度坐标
        var clickEventListener = map.on('click', function(e) {
            $("#lon").val(e.lnglat.lng);
            $("#lat").val(e.lnglat.lat);
            console.log(e.lnglat.lng)
            console.log(e.lnglat.lat)
            // 填写地址
            writeAddress([e.lnglat.lng,e.lnglat.lat]);
            mapsearch();
        });
        //placeSearch.search("北京");
        $("#addressmap").on("keydown",function(event){
            if(event = event || window.event){
                if(event.keyCode==13){
                    markLocation();
                }
            }
        });
    });

    //地图搜索
    function mapsearch(){
        var mlon = $("#lon").val();
        var mlat = $("#lat").val();
        myMapViewLocation(mlon, mlat);
    }
    // 回显
    function myMapViewLocation(mlon, mlat){
        //console.log("回显坐标");
        if(mlon&&mlat){
            //removeMarkers(lnglatXY);
            lnglatXY = [mlon,mlat];
            addMarker(lnglatXY);
        }
    }
    //移除之前的标点
    function removeMarkers(lnglatXY){
        marker = new AMap.Marker({
            map: map,
            position: lnglatXY,
            icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
            offset: new AMap.Pixel(-13, -30)
        });
        var markers = [];
        markers.push(marker);
        map.remove(markers);
    }

    var t=1;
    // 实例化点标记
    function addMarker(lnglatXY) {
        if(t == 1) {
            console.log(lnglatXY);
            marker = new AMap.Marker({
                icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
                position: lnglatXY,
                offset: new AMap.Pixel(-13, -30),
                // 设置是否可以拖拽
                draggable: true,
                cursor: 'move',
                // 设置拖拽效果
                raiseOnDrag: true
            });
            marker.setMap(map);
            map.setFitView();// 执行定位
            t++;
        }

        //修改标点位置
        if(t != 1){
            marker.setPosition(lnglatXY);
            map.setCenter(lnglatXY);
            marker.setMap(map);
            map.setFitView();// 执行定位
        }

    }

    // 填写地址
    function writeAddress(lnglatXY){
        var geocoder = new AMap.Geocoder({
            city : "全国", //城市，默认：“全国”
            radius : 500 //范围，默认：500
        });
        geocoder.getAddress(lnglatXY, function(status, result) {
            console.log(result)
            if (status === 'complete' && result.info === 'OK') {
                geocoder_CallBack(result);
            }
        });
    }

    // 地址回调
    function geocoder_CallBack(data) {
        var address = data.regeocode.formattedAddress; //返回地址描述
        $("input[name=resourceAddress]").val(address);
    }
    //根据地址搜索
    function markLocation() {
        var address = $("#addressmap").val();
        AMap.plugin('AMap.Geocoder', function() {
            var geocoder = new AMap.Geocoder();
            geocoder.getLocation(address, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    // 经纬度        
                    console.log(result)
                    $("#addressmap").val(result.geocodes[0].formattedAddress)         
                    var lon = result.geocodes[0].location.lng;
                    var lat = result.geocodes[0].location.lat;

                    $("#lon").val(lon);
                    $("#lat").val(lat);

                    lnglatXY = [lon, lat];
                    addMarker(lnglatXY);
                } else {
                    console.log(status)
                    console.log(result)
                    alert('搜索失败！');
                    $("#addressmap").val('')
                }
            });
        });
    }
</script>
</body>
</html>
